
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üèÜ MySymptoms Nurse Championship!!! üèÜ</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#1a1f36;
      --muted:#64748b;
      --accent:#4f46e5;
      --gold:#f59e0b;
      --silver:#94a3b8;
      --bronze:#c2410c;
      --pill:#eef2ff;
      --ok:#10b981;
      --shadow: 0 6px 20px rgba(17,24,39,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:760px;margin:0 auto;padding:16px 16px 120px}
    header{display:flex;align-items:center;gap:12px;padding:16px 0 8px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#22d3ee);box-shadow:var(--shadow);}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .tabs{display:flex;gap:8px;margin:16px 0 10px;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:2}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:999px;background:var(--pill);color:var(--accent);font-weight:600;cursor:pointer;border:1px solid rgba(79,70,229,.15);}
    .tab[aria-selected="true"]{background:var(--accent);color:white;box-shadow:var(--shadow)}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:12px;margin:10px 0;display:flex;align-items:center;gap:12px;}
    .rank{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;font-weight:700;color:white;flex-shrink:0;}
    .rank.gold{background:linear-gradient(145deg,#f59e0b,#fbbf24)}
    .rank.silver{background:linear-gradient(145deg,#94a3b8,#cbd5e1)}
    .rank.bronze{background:linear-gradient(145deg,#c2410c,#fb923c)}
    .rank.default{background:#a78bfa}
    .avatar{width:40px;height:40px;border-radius:12px;background:#eef2ff;color:#4f46e5;display:grid;place-items:center;font-weight:700;flex-shrink:0;}
    .meta{flex:1;min-width:0}
    .name{font-weight:700;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small{color:#64748b;font-size:12px;margin-top:2px}
    .score{font-weight:800;font-size:18px;color:#10b981;}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#ecfeff;color:#0e7490;font-size:12px;font-weight:700;border:1px solid #a5f3fc;margin-left:6px;}
    .section-title{margin:18px 4px 6px;color:#64748b;font-weight:700;font-size:12px;letter-spacing:.06em;text-transform:uppercase}
    .footer-note{color:#64748b;font-size:12px;margin-top:14px;text-align:center}
    .hidden{display:none}
    .controls{display:flex;gap:8px;align-items:center;margin:8px 2px 12px}
    select,button{padding:10px 12px;border-radius:10px;border:1px solid #e2e8f0;background:white;font-weight:600;color:#1a1f36;}
    button.primary{background:#4f46e5;color:white;border-color:transparent}
    .hint{font-size:12px;color:#64748b}
    canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:99}
  </style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>üèÜ MySymptoms Nurse Championship!!! üèÜ</h1>
      <div class="sub">Are you a MySymptoms Champion? A leader of digital transformation for your ward? Who amongst you will come out on top? Join the championship to find out!</div>
    </div>
  </header>

  <div role="tablist" class="tabs">
    <div class="tab" role="tab" id="tab-adv" aria-controls="panel-adv" aria-selected="true">Division 1 ¬∑ Highest Introduction Rate </div>
    <div class="tab" role="tab" id="tab-rev" aria-controls="panel-rev" aria-selected="false">Division 2 ¬∑ Highest Nexus Review Rate</div>
    <div class="tab" role="tab" id="tab-pts" aria-controls="panel-pts" aria-selected="false">Championship Points</div>
  </div>

  <div id="panel-adv" role="tabpanel">
    <div class="controls">
      <select id="adv-period">
        <option value="today">Today</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="all">All-time</option>
      </select>
      <button class="primary" id="refresh">Refresh</button>
      <span class="hint">Data auto-sorts by score</span>
    </div>
    <div class="section-title">Top Nurses</div>
    <div id="list-adv"></div>
    <div class="footer-note">Division 1 counts nurses who introduced MySymptoms to patients/caregivers with at least 1 entry.</div>
  </div>

  <div id="panel-rev" role="tabpanel" class="hidden">
    <div class="controls">
      <select id="rev-period">
        <option value="today">Today</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="all">All-time</option>
      </select>
      <button class="primary" id="refresh2">Refresh</button>
      <span class="hint">Data auto-sorts by score</span>
    </div>
    <div class="section-title">Top Nurses</div>
    <div id="list-rev"></div>
    <div class="footer-note">Division 2 counts nurses by number of MySymptoms data reviewed on NexusViewer.</div>
  </div>
</div>

<div id="panel-pts" role="tabpanel" class="hidden">
  <div class="controls">
    <select id="pts-period">
      <option value="today">Today</option>
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="all">All-time</option>
    </select>
    <button class="primary" id="refresh-pts">Refresh</button>
  </div>
  <div class="section-title">Championship Standings (Introductions + Reviews)</div>
  <div id="list-pts"></div>
  <div class="footer-note">Top nurse each day in each division earns 1 point. Ties for first: each tied nurse earns 1 point.</div>
</div>


<script>
const CSV_ADV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgOmM5oc-z4f_mMYkyuXjQ03e2nQS4r2YpTfG9n2X_Ex6Q4ob4vBKQ0mzyxPMQ3KIDHPDxTqyfUPkk/pub?output=csv";
const CSV_REV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbg5rxJiuAJZy5wRfKYyx_HiqcyIDquJZSGadvAmhThTuGLt_tRxD2JhYNOAser5el05qEdAUJaHrh/pub?output=csv";

function parseCSV(text){
  const rows = text.trim().split(/\r?\n/);
  const headers = rows[0].split(",").map(h=>h.trim().toLowerCase());
  return rows.slice(1).map(line => {
    const parts = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const c = line[i];
      if (c === '"'){ inQ = !inQ; continue; }
      if (c === ',' && !inQ){ parts.push(cur); cur=""; continue; }
      cur += c;
    }
    parts.push(cur);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (parts[idx]||"").trim());
    return obj;
  });
}

function daysAgo(n){
  const d = new Date();
  d.setDate(d.getDate()-n);
  d.setHours(0,0,0,0);
  return d;
}

function filterByPeriod(data, periodValue){
  if (periodValue === "all") return data;
  if (periodValue === "today") {
    const start = new Date(); start.setHours(0,0,0,0);
    const end   = new Date(); end.setHours(23,59,59,999);
    return data.filter(r => {
      const dt = new Date(r.date || r.Date || r.timestamp || r.Timestamp);
      return !isNaN(dt) && dt >= start && dt <= end;
    });
  }
  const cutoff = daysAgo(parseInt(periodValue,10));
  return data.filter(r => {
    const dt = new Date(r.date || r.Date || r.timestamp || r.Timestamp);
    return !isNaN(dt) && dt >= cutoff;
  });
}

function toInitials(name){
  if(!name) return "?";
  return name.split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||"").join("");
}

function renderList(el, rows){
  el.innerHTML = "";
  rows.forEach((r, idx) => {
    const rankClass = idx===0 ? "gold" : idx===1 ? "silver" : idx===2 ? "bronze" : "default";
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="rank ${rankClass}">${idx+1}</div>
      <div class="avatar">${toInitials(r.nurse)}</div>
      <div class="meta">
        <div class="name">${r.nurse || "(unknown)"} <span class="pill">${r.ward||""}</span></div>
        <div class="small">Entries counted: ${r.count}</div>
      </div>
      <div class="score">${r.count}</div>
    `;
    el.appendChild(div);
  });
  if (rows.length && rows[0].count > 0) burstConfetti();
}

async function loadAndRender(csvUrl, periodValue, targetEl){
  try{
    const res = await fetch(csvUrl);
    const txt = await res.text();
    let data = parseCSV(txt);
    const filtered = filterByPeriod(data, periodValue);
    const agg = {};
    filtered.forEach(r => {
      const nurse = r.nurse || r.Nurse || r.name || r.Name || "Unknown";
      const ward = r.ward || r.Ward || "";
      const count = Number(r.count || r.Count || 0);
      const key = nurse + "||" + ward;
      if (!agg[key]) agg[key] = { nurse, ward, count: 0 };
      agg[key].count += (isNaN(count) ? 0 : count);
    });
    const rows = Object.values(agg).sort((a,b)=> b.count - a.count).slice(0,50);
    renderList(targetEl, rows);
  }catch(e){
    targetEl.innerHTML = "<div class='small' style='padding:8px;color:#ef4444'>Could not load data. Check the CSV link.</div>";
    console.error(e);
  }
}

const tabAdv = document.getElementById("tab-adv");
const tabRev = document.getElementById("tab-rev");
const panelAdv = document.getElementById("panel-adv");
const panelRev = document.getElementById("panel-rev");
tabAdv.addEventListener("click", ()=>{
  tabAdv.setAttribute("aria-selected","true");
  tabRev.setAttribute("aria-selected","false");
  panelAdv.classList.remove("hidden");
  panelRev.classList.add("hidden");
});
tabRev.addEventListener("click", ()=>{
  tabRev.setAttribute("aria-selected","true");
  tabAdv.setAttribute("aria-selected","false");
  panelRev.classList.remove("hidden");
  panelAdv.classList.add("hidden");
});

const advSel = document.getElementById("adv-period");
const revSel = document.getElementById("rev-period");
const listAdv = document.getElementById("list-adv");
const listRev = document.getElementById("list-rev");
document.getElementById("refresh").addEventListener("click", ()=> loadAndRender(CSV_ADV, advSel.value, listAdv));
document.getElementById("refresh2").addEventListener("click", ()=> loadAndRender(CSV_REV, revSel.value, listRev));

loadAndRender(CSV_ADV, advSel.value, listAdv);
loadAndRender(CSV_REV, revSel.value, listRev);

const canvas = document.getElementById("confetti");
const ctx = canvas.getContext("2d");
let confetti = [];
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize); resize();

function burstConfetti(){
  confetti = [];
  for(let i=0;i<120;i++){
    confetti.push({
      x: Math.random()*canvas.width,
      y: -10 - Math.random()*40,
      r: 3 + Math.random()*3,
      vx: (Math.random()-0.5)*2,
      vy: 2 + Math.random()*3,
      life: 60 + Math.random()*60
    });
  }
  animate();
}
function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  confetti.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = "hsl(" + (Math.random()*360) + ",90%,60%)";
    ctx.fill();
    p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.life--;
  });
  confetti = confetti.filter(p=> p.life>0 && p.y<canvas.height+20);
  if (confetti.length) requestAnimationFrame(animate);
}

function parseScheme(s) {
  return s.split('-').map(x => Number(x)||0).filter(x=>x>0);
}

function groupBy(arr, keyFn) {
  const m = new Map();
  arr.forEach(item => {
    const k = keyFn(item);
    if (!m.has(k)) m.set(k, []);
    m.get(k).push(item);
  });
  return m;
}

function aggregatePerDay(rows) {
  const dayGroups = groupBy(rows, r => (r.date || r.Date));
  const out = new Map(); 
  dayGroups.forEach((items, day) => {
    const perNurse = new Map();
    items.forEach(r => {
      const nurse = r.nurse || r.Nurse || r.name || r.Name || "Unknown";
      const cnt   = Number(r.count || r.Count || 0) || 0;
      perNurse.set(nurse, (perNurse.get(nurse) || 0) + cnt);
    });
    const arr = Array.from(perNurse.entries()).map(([nurse,total]) => ({ nurse, total }));
    arr.sort((a,b)=> b.total - a.total);
    out.set(day, arr);
  });
  return out;
}

function awardDailyTop1(sortedArray) {
  const points = new Map();
  if (!sortedArray.length) return points;
  const topScore = sortedArray[0].total;
  const winners = sortedArray.filter(x => x.total === topScore);
  winners.forEach(w => points.set(w.nurse, 1));
  return points;
}

function buildChampionshipTop1PerDivision(advRows, revRows, periodValue) {
  const fAdv = filterByPeriod(advRows, periodValue);
  const fRev = filterByPeriod(revRows, periodValue);

  const advPerDay = aggregatePerDay(fAdv);
  const revPerDay = aggregatePerDay(fRev);

  const standings = new Map(); 

  advPerDay.forEach(arr => {
    const daily = awardDailyTop1(arr);
    daily.forEach((p, nurse) => standings.set(nurse, (standings.get(nurse)||0) + p));
  });

  revPerDay.forEach(arr => {
    const daily = awardDailyTop1(arr);
    daily.forEach((p, nurse) => standings.set(nurse, (standings.get(nurse)||0) + p));
  });

  return Array.from(standings.entries())
    .map(([nurse, pts]) => ({ nurse, ward: "", count: pts }))
    .sort((a,b)=> b.count - a.count)
    .slice(0,50);
}

async function refreshPointsPanel() {
  try {   
    const [advTxt, revTxt] = await Promise.all([fetch(CSV_ADV).then(r=>r.text()), fetch(CSV_REV).then(r=>r.text())]);
    const advRows = parseCSV(advTxt);
    const revRows = parseCSV(revTxt);

    const period = document.getElementById('pts-period').value;
    const standings = buildChampionshipTop1PerDivision(advRows, revRows, period);

    const list = document.getElementById('list-pts');
    list.innerHTML = "";
    standings.forEach((r, idx) => {
      const rankClass = idx===0 ? "gold" : idx===1 ? "silver" : idx===2 ? "bronze" : "default";
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="rank ${rankClass}">${idx+1}</div>
        <div class="avatar">${toInitials(r.nurse)}</div>
        <div class="meta">
          <div class="name">${r.nurse}</div>
          <div class="small">Championship points (Introductions + Reviews)</div>
        </div>
        <div class="score">${r.count}</div>
      `;
      list.appendChild(div);
    });
  } catch (e) {
    const list = document.getElementById('list-pts');
    list.innerHTML = "<div class='small' style='padding:8px;color:#ef4444'>Could not compute championship points.</div>";
    console.error(e);
  }
}

const tabPts  = document.getElementById("tab-pts");
const panelPts= document.getElementById("panel-pts");
if (tabPts) {
  tabPts.addEventListener("click", ()=>{
    tabAdv.setAttribute("aria-selected","false");
    tabRev.setAttribute("aria-selected","false");
    tabPts.setAttribute("aria-selected","true");
    panelAdv.classList.add("hidden");
    panelRev.classList.add("hidden");
    panelPts.classList.remove("hidden");
    refreshPointsPanel();
  });
}
const refreshPtsBtn = document.getElementById("refresh-pts");
if (refreshPtsBtn) {
  refreshPtsBtn.addEventListener("click", refreshPointsPanel);
}
const ptsPeriod = document.getElementById("pts-period");
if (ptsPeriod) {
  ptsPeriod.addEventListener("change", refreshPointsPanel);
}

</script>
</body>
</html>
